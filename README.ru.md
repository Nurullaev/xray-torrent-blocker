# Xray Torrent Blocker

[![en](https://img.shields.io/badge/lang-en-red)](https://github.com/kutovoys/xray-torrent-blocker/blob/main/README.md)
[![ru](https://img.shields.io/badge/lang-ru-blue)](https://github.com/kutovoys/xray-torrent-blocker/blob/main/README.ru.md)

Xray Torrent Blocker — это приложение для блокировки использования торрентов пользователями панелей на базе [Xray](https://github.com/XTLS/Xray-core). Приложение анализирует логи, обнаруживает использование торрентов и временно блокирует пользователя, отправляя уведомления в Telegram администратору и, опционально, пользователю.

## Возможности:

- Мониторинг логов нод и панели на предмет использования торрентов.
- Блокировка IP-адресов на уровне системы. Максимальная скорость блокировки (Абузы не придут!).
- Отправка уведомлений в Telegram как администратору, так и пользователю.
- Возможность настройки через конфигурационный файл.
- Использование UFW для блокировки.
- Настраиваемое время блокировки.
- Поддержка временной блокировки с последующей разблокировкой.
- Простая установка и настройка через systemd.
- Сохранение состояния блокировок между перезапусками приложения.
- Автоматическое восстановление блокировок после перезагрузки системы.
- Автоматическая очистка просроченных блокировок.
- Поддержка вебхуков.

## Подготовка

### Конфигурация Xray

- Включение логирования. Секция `log`
  ```json
    "log": {
      "access": "/var/lib/marzban-node/access.log",
      "error": "/var/lib/marzban-node/error.log",
      "loglevel": "error",
      "dnsLog": false
    },
  ```
- Настройка маркировки bittorrent трафика. Секция `routing`. Добавляем правило:

  ```json
        {
          "protocol": [
            "bittorrent"
          ],
          "outboundTag": "TORRENT",
          "type": "field"
        },
  ```

  Здесь `TORRENT` это маркировка, по которой приложение будет фильтровать логи.

- Настройка блокировки bittorrent трафика. Секция `outbounds`. Отправляем все в blackhole:
  ```json
      {
        "protocol": "blackhole",
        "tag": "TORRENT"
      },
  ```
  К сожалению, эта блокировка эффективно блокирует только около 20% трафика bittorrent.

### Конфигурация Marzban

- На сервере, где находится панель создайте папку `/var/lib/marzban-node`:

  ```bash
  mkdir -p /var/lib/marzban-node
  ```

- Добавьте новый volume в файле `/opt/marzban/docker-compose.yml`:

  ```yaml
  volumes:
    - /var/lib/marzban:/var/lib/marzban
    - /var/lib/marzban-node:/var/lib/marzban-node #новый volume
  ```

- Перезапустите панель командой:
  ```bash
  docker compose down --remove-orphans; docker compose up -d
  ```

### Конфигурация нод

Проверьте чтобы в docker-compose.yml был правильно смонтированный volume:

```yaml
volumes:
  - /var/lib/marzban-node:/var/lib/marzban-node
```

По умолчанию он там есть. Тем самым мы вынесем логи на хост.

## Установка

Для автоматической установки приложения выполните следующие шаги:

- Запустите скрипт установки:
  ```bash
  bash <(curl -fsSL git.new/install)
  ```
- Скрипт автоматически установит все зависимости, скачает последний релиз, спросит `Token` и `Chat ID` администратора и запустит сервис.
- После завершения установки приложение можно контролировать через systemd:
  ```bash
  systemctl start/status/stop tblocker
  ```

### Конфигурация logrotate для Marzban Node

Ниже представлена конфигурация, которая необходима для того, чтобы избежать переполнения вашей системы логами.

```bash
/var/lib/marzban-node/*.log {
    size 50M
    rotate 5
    compress
    missingok
    notifempty
    copytruncate
}
```

Вы можете установить logrotate и применить эту конфигурацию с помощью следующей команды:

```bash
sudo apt update && sudo apt install logrotate && sudo bash -c 'cat > /etc/logrotate.d/marzban-node <<EOF
/var/lib/marzban-node/*.log {
    size 50M
    rotate 5
    compress
    missingok
    notifempty
    copytruncate
}
EOF' && logrotate -vf /etc/logrotate.d/marzban-node
```

## Конфигурация

После установки вы можете настроить поведение приложения через файл конфигурации, который находится по пути: `/opt/tblocker/config.yaml`.

Основные параметры конфигурации:

- **LogFile** — путь к файлу логов, который будет мониториться. По умолчанию: `/var/lib/marzban-node/access.log`
- **BlockDuration** — продолжительность блокировки пользователя в минутах. По умолчанию: `10`
- **TorrentTag** — тег, по которому приложение определяет строки лога, связанные с торрентами. По умолчанию: `TORRENT`
- **BlockMode** — указывает, какой инструмент использовать для блокировки IP-адресов. Опционально. По умолчанию: `ufw`
- **BypassIPS** — указывает IP-адреса, которые не будут заблокированы. Опционально. По умолчанию: `127.0.0.1, ::1`
- **SendAdminMessage** - отправлять ли уведомления администратору. Опционально. По умолчанию: `true`
- **AdminBotToken** — токен административного бота для уведомлений. Опционально.
- **AdminChatID** — ID чата (или пользователя) администратора, куда будут отправляться уведомления. Опционально.
- **SendUserMessage** — отправлять ли уведомления пользователю. Опционально. По умолчанию: `false`
- **BotToken** — токен бота для отправки сообщений пользователю в Telegram. Опционально.
- **TidRegex** — регулярное выражение для извлечения `CHAT_ID` пользователя из строки лога. Опционально.
- **UserMessageTemplate** — шаблон сообщения для уведомления пользователя. Опционально.
- **UsernameRegex** — регулярное выражение для извлечения логина пользователя из строки лога. Опционально.
- **SendWebhook** — отправлять ли уведомления через вебхук. Опционально. По умолчанию: `false`
- **WebhookURL** — URL для отправки вебхуков. Опционально.
- **WebhookTemplate** - щаблон JSON для вебхука. Опционально.
- **StorageDir** — путь к директории для хранения данных о блокировках. По умолчанию: `/opt/tblocker`
- **WebhookHeaders** — дополнительные HTTP-заголовки, которые будут добавлены к вебхукам. Опционально.

Пример файла конфигурации с подробными комментариями находится в `/opt/tblocker/config.yaml.example`

### Пример для отправки сообщений пользователю:

Если в логине пользователя панели Marzban используется его `CHAT_ID`, вы можете настроить приложение для отправки уведомлений непосредственно этому пользователю.

Например, если логин пользователя в Marzban выглядит так: `kutovoys_tgid-1234111`, в `config.yaml` необходимо задать следующие параметры:

- **TidRegex**: `tgid-(\\d+)`
- **UsernameRegex**: `email: \\d+\\.(\\w+)_tgid-`

В таком случае администратор будет получать уведомления с именем пользователя `kutovoys`, а пользователь будет получать сообщения о блокировке напрямую через Telegram.

### Хранение данных о блокировках

Приложение сохраняет информацию о блокировках в JSON-файл в директории, указанной в параметре `StorageDir`. Это обеспечивает:

- Сохранение состояния блокировок между перезапусками приложения
- Автоматическое восстановление блокировок после перезагрузки системы
- Корректную разблокировку пользователей даже после перезапуска приложения
- Автоматическую очистку просроченных блокировок

Файл с данными о блокировках находится по пути: `/opt/tblocker/blocked_ips.json`

## Contributing

Мы приветствуем вклад от сообщества! Если у вас есть идеи для улучшений или вы нашли баг, пожалуйста, создайте issue или отправьте pull request на GitHub.

## Рекомендация VPN

Для безопасного и надежного доступа в интернет мы рекомендуем [BlancVPN](https://getblancvpn.com/?ref=tblocker). Используйте промокод `TRYBLANCVPN` для получения скидки 15% на вашу подписку.
